name: Build Euphonica AArch64 DEB (Unstable Container)

on:
  workflow_dispatch:

jobs:
  build_arm64_deb:
    # 1. Use the ARM runner
    runs-on: ubuntu-24.04-arm 
    
    # 2. Use the Debian Unstable (sid) container for the newest GTK4
    container:
      image: debian:sid-slim # Unstable branch for maximum GTK version
      options: --user root

    steps:
    - name: ‚¨áÔ∏è Checkout Repository
      uses: actions/checkout@v4
      with:
        repository: 'htkhiem/euphonica'

    - name: ü¶Ä Install Rust Toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: ‚öôÔ∏è Install Build Dependencies (Debian Sid)
      run: |
        # Update package lists
        apt-get update
        
        # Install all necessary dependencies (No 'sudo' needed)
        apt-get install -y \
          build-essential \
          git \
          meson \
          ninja-build \
          pkg-config \
          libdbus-1-dev \
          libgtk-4-dev \
          libadwaita-1-dev \
          libpipewire-0.3-dev \
          libsqlite3-dev \
          libssl-dev \
          libsecret-1-dev \
          gettext \
          clang \
          xdg-desktop-portal-gtk \
          libdconf-dev \
          libmpdclient-dev \
          desktop-file-utils \
          libxml2-utils
          
    - name: ‚öôÔ∏è Fetch Submodules Manually
      run: |
        # This command runs *inside* the container, where Git is fully installed.
        git submodule update --init --recursive

    - name: üî® Configure Meson Build
      run: |
        # In a standard Debian environment, PKG_CONFIG_PATH should be correct.
        meson setup build --buildtype=release --prefix=/usr

    - name: üì¶ Compile and Stage Install
      run: |
        ninja -C build
        DESTDIR=./package meson install -C build

    - name: üéÅ Create DEB Package (Stable Echo)
      run: |
        mkdir -p ./package/DEBIAN

        # Use stable echo commands to create the control file
        CONTROL_FILE="./package/DEBIAN/control"
        echo "Package: euphonica" > $CONTROL_FILE
        echo "Version: 1.0.0-git-latest" >> $CONTROL_FILE
        echo "Architecture: arm64" >> $CONTROL_FILE
        echo "Maintainer: Euphonica Developers <none@email.com>" >> $CONTROL_FILE
        echo "Description: Euphonica MPD Client" >> $CONTROL_FILE
        # Dependencies are stable between Ubuntu/Debian for these core libraries.
        echo "Depends: libdbus-1-3, libgtk-4-1, libadwaita-1-0, libpipewire-0.3-0, libsqlite3-0, libssl3, libsecret-1-0, dconf-gsettings-backend, libdconf1, libmpdclient2" >> $CONTROL_FILE
        
        dpkg-deb --build ./package

    - name: ‚¨ÜÔ∏è Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: euphonica-arm64-deb
        path: package.deb
