name: Build Euphonica AArch64 DEB (Unstable Container)

on:
  workflow_dispatch:
  push:
  
jobs:
  build_arm64_deb:
    # 1. Use the ARM runner
    runs-on: ubuntu-24.04-arm 
    
    # 2. Use the Debian Unstable (sid) container for the newest GTK4
    container:
      image: debian:sid-slim # Unstable branch for maximum GTK version
      options: --user root
    steps:
    - name: ‚öôÔ∏è Install Build Dependencies (Debian Sid)
      run: |
        # Update package lists
        apt-get update
        apt-get install sudo git wget curl jq -y
        
    - name: ‚¨áÔ∏è Checkout Repository
      uses: actions/checkout@v4
      with:
        repository: 'htkhiem/euphonica'
        submodules: 'recursive'
        
    - name: ü¶Ä Install Rust Toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: ‚öôÔ∏è Install Build Dependencies (Debian Sid)
      run: |
        # Update package lists
        apt-get update
        
        # Install all necessary dependencies (No 'sudo' needed)
        apt-get install -y \
          build-essential \
          git \
          meson \
          ninja-build \
          pkg-config \
          libdbus-1-dev \
          libgtk-4-dev \
          libadwaita-1-dev \
          libpipewire-0.3-dev \
          libsqlite3-dev \
          libssl-dev \
          libsecret-1-dev \
          gettext \
          clang \
          xdg-desktop-portal-gtk \
          libdconf-dev \
          libmpdclient-dev \
          desktop-file-utils \
          libxml2-utils
          
    - name: üî® Configure Meson Build
      run: |
        # In a standard Debian environment, PKG_CONFIG_PATH should be correct.
        meson setup build --buildtype=release --prefix=/usr

    - name: üì¶ Compile and Stage Install (TRUSTED PACKAGE STAGING)
      run: |
        # 1. Create the absolute staging directory
        mkdir -p /package
        
        # 2. Compile the project
        ninja -C build
        
        # 3. Run the meson install command, targeting the absolute path /package
        # This installs the vast majority of files (desktop, icons, etc.)
        DESTDIR=/package meson install -C build
        
        # --- START OF BACKUP SOLUTION trademark: TARGETED FIXES ---
        
        # 4. BACKUP: Capture the main executable (euphonica)
        if [ ! -f /package/usr/bin/euphonica ]; then
          echo "WARNING: Binary missing from /package/usr/bin/. Attempting manual copy..."
          COMPILED_BINARY=$(find build -name "euphonica" -type f -executable | head -n 1)
          if [ -f "$COMPILED_BINARY" ]; then
            mkdir -p /package/usr/bin
            cp "$COMPILED_BINARY" /package/usr/bin/
            echo "SUCCESS: Binary manually copied."
          else
            echo "ERROR: Compiled binary not found! Exiting."
            exit 1
          fi
        fi
        
        # 5. BACKUP: Capture the missing GResource file (euphonica.gresource)
        # This file MUST be present to resolve the "Failed to open file" panic.
        if [ ! -f /package/usr/share/euphonica/euphonica.gresource ]; then
          echo "WARNING: GResource file missing. Attempting manual copy..."
          
          # Reliably find the resource file in the build output
          GRESOURCE_FILE=$(find build -name "euphonica.gresource" | head -n 1)
          
          if [ -f "$GRESOURCE_FILE" ]; then
            # Copy the GResource file into the absolute staging path
            mkdir -p /package/usr/share/euphonica
            cp "$GRESOURCE_FILE" /package/usr/share/euphonica/
            echo "SUCCESS: GResource file manually copied."
          else
            echo "ERROR: euphonica.gresource resource file not found! Exiting."
            exit 1
          fi
        fi
        # --- END OF BACKUP SOLUTION trademark ---

    - name: üéÅ Create Deployable Tarball
      run: |
        # ARCHIVE THE ENTIRE CONTENTS OF THE ABSOLUTE STAGING FOLDER /package
        tar -czvf euphonica-arm64-deploy.tar.gz -C /package .
        
    - name: ‚¨ÜÔ∏è Upload Artifact (Tarball)
      uses: actions/upload-artifact@v4
      with:
        name: euphonica-arm64-deploy-tarball
        path: euphonica-arm64-deploy.tar.gz
